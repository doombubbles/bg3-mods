{{- $alterTimeDuration := 3 -}}

new entry "Shout_TimeWarp"
type "SpellData"
using "Target_Haste"
data "SpellType" "Shout"
data "Level" "6"
data "DisplayName" "hb3aa30bbg94b1g4aabgadb8g0e7fbbc0b9b6"
data "Description" "h30f900dfg7be3g4e3ega85eg03c6ae38252b"
data "UseCosts" "ActionPoint:1;SpellSlotsGroup:1:1:6"
data "Icon" "Spell_Wizard_TimeWarp"

new entry "TimeHealsAllWounds"
type "PassiveData"
data "DisplayName" "ha75a1783g8453g48a8ga0dag6fe2f12b4922"
data "Description" "h35d66002g9daag43f5g8a52g19602d973abc"
data "Icon" "Spell_Evocation_HealingWord"
data "Properties" ""

// TODO different name?
new entry "MasterOfTime"
type "PassiveData"
data "DisplayName" "h8366c262g05d4g4d5fg8cc8g483ee4fc6924"
data "Description" "h2fde50cagf987g4388g860bgc0ff6543ba3b"
data "Icon" "Spell_Transmutation_Slow"
data "Properties" "Highlighted"
data "Boosts" "UnlockSpellVariant(SpellCheck('Target_Slow'),ModifySavingThrowDisadvantage())"
data "StatsFunctorContext" "OnStatusApply"
data "Conditions" "StatusId('HASTE') or StatusId('POTION_OF_SPEED') or StatusId('HASTE_SURFACE') or StatusId('CONS_DRUG_STIMULANT')"
data "StatsFunctors" "ApplyStatus(HASTE_SLOW_NOT_LETHARGIC,100,-1)"

new entry "HASTE_SLOW_NOT_LETHARGIC"
type "StatusData"
data "StatusType" "BOOST"
data "DisplayName" "h8366c262g05d4g4d5fg8cc8g483ee4fc6924"
data "Description" "h2fde50cagf987g4388g860bgc0ff6543ba3b"
data "Icon" "Spell_Transmutation_Slow"
data "StatusPropertyFlags" "DisableOverhead;DisableCombatlog;DisablePortraitIndicator"
data "Boosts" "StatusImmunity(HASTE_LETHARGY)"
data "RemoveEvents" "OnStatusRemoved"
data "RemoveConditions" "StatusId('HASTE') or StatusId('POTION_OF_SPEED') or StatusId('HASTE_SURFACE') or StatusId('CONS_DRUG_STIMULANT')"
data "OnRemoveFunctors" "ApplyStatus(SELF,SLOW,100,1)"


new entry "Shout_AlterTime"
type "SpellData"
data "SpellType" "Shout"
using "Shout_Blink"
data "DisplayName" "h1ecfc9d3g4b31g4521g9900g4b53c69bc884"
data "Description" "h8524efa2g0cccg4c82g84e9g6519736a1ff7"
data "DescriptionParams" "10"
data "ExtraDescription" ""
data "Level" ""
data "SpellProperties" "ApplyStatus(SELF,ALTERING_TIME,100,{{$alterTimeDuration}});GROUND:Summon(63a52705-056b-4736-91ee-66b839de2afe,10,,,AlterTimeStack,ALTER_TIME_MARKER,UNSUMMON_ABLE);"
data "Cooldown" "OncePerShortRest"
data "UseCosts" "BonusActionPoint:1"
data "Requirements" ""
data "TooltipStatusApply" "ApplyStatus(ALTERING_TIME,100,{{$alterTimeDuration}})"
data "Icon" "Spell_Wizard_AlterTime"


new entry "ALTER_TIME_MARKER"
type "StatusData"
data "StatusType" "BOOST"
data "DisplayName" "h45cc8525g3944g4d0aga1a3g004fd83121a1"
data "Description" ""
data "StatusPropertyFlags" "DisableOverhead;DisableCombatlog;DisablePortraitIndicator;ApplyToDead"
data "StatusEffect" "41a4d8ca-f29d-486a-9f4e-afd9deb55b62"
data "Icon" "Spell_Wizard_AlterTime"

new entry "ALTERING_TIME"
type "StatusData"
data "StatusType" "BOOST"
data "DisplayName" "h45cc8525g3944g4d0aga1a3g004fd83121a1"
data "Description" "hbb0ec526g2be1g42ecgb914g3a8187f250b8"
data "StatusPropertyFlags" ""
data "StackId" "ALTERING_TIME"
data "Boosts" "UnlockSpell(Shout_AlterTime_Teleport)"
data "RemoveEvents" "OnSpellCast"
data "RemoveConditions" "SpellId('Shout_AlterTime_Teleport') or SpellId('Target_AlterTime_Teleport')"
data "Icon" "Spell_Wizard_AlterTime"
data "OnApplyFunctors" "{{ range $hp := untilStep 0 200 5 }}IF(AT({{$hp}})):ApplyStatus(SELF,AT_{{$hp}},100,10);{{end}}"
data "OnRemoveFunctors" "IF(RemoveCause(StatusRemoveCause.TimeOut)):ApplyStatus(SELF,RETRY_ALTERING_TIME,100,-1);IF(RemoveCause(StatusRemoveCause.TimeOut)):UseSpell(Shout_AlterTime_Teleport,true,true,true)"
data "StatusGroups" "SG_RemoveOnRespec"

new entry "RETRY_ALTERING_TIME"
type "StatusData"
data "StatusType" "BOOST"
using "ALTERING_TIME"
data "TickType" "StartTurn"
data "TickFunctors" "UseSpell(Shout_AlterTime_Teleport,true,true,true)"
data "StatusPropertyFlags" "DisableOverhead;DisableCombatlog;DisablePortraitIndicator"


{{ range $hp := untilStep 0 200 5 }}
new entry "AT_{{$hp}}"
type "StatusData"
data "StatusType" "BOOST"
data "DisplayName" ""
data "Description" ""
data "StackId" "ALTERING_TIME_HP"
data "StackPriority" "{{$hp}}"
data "StatusPropertyFlags" "DisableOverhead;DisableCombatlog;DisablePortraitIndicator;ApplyToDead"
data "RemoveEvents" "OnStatusRemoved"
data "RemoveConditions" "StatusId('ALTERING_TIME')"
data "OnRemoveFunctors" "{{range $i := untilStep 0 200 5}}{{if gt $hp $i}}IF(AT({{$i}})):RegainHitPoints(SELF,{{sub $hp $i}});{{end}}{{if lt $hp $i}}IF(AT({{$i}})):DealDamage(SELF,{{sub $i $hp}});{{end}}{{end}}"
data "StatusGroups" "SG_RemoveOnRespec"
{{ end }}



new entry "Target_AlterTime_Teleport"
type "SpellData"
data "SpellType" "Target"
using "Target_MistyStep"
data "SpellSchool" ""
data "Level" ""
data "UseCosts" "BonusActionPoint:1"
data "DisplayName" "h5137a7a0gb2c8g466bg9d0bg1b839b92c96d"
data "Description" "he357fc0cgaf87g49bfgbf6egebb163601da9"
data "TargetRadius" "1000"
data "SpellProperties" "SwapPlaces();Unsummon();GROUND:RemoveStatus(SELF,RETRY_ALTERING_TIME)"
data "TargetConditions" "HasStatus('ALTER_TIME_MARKER',context.Target) and Self(context.Source,GetOwner(context.Target))"
data "SpellFlags" "HasVerbalComponent;IsSpell;HasHighGroundRangeExtension;RangeIgnoreVerticalThreshold;Temporary;IgnoreVisionBlock"
data "Icon" "Spell_Wizard_AlterTime"
data "MaximumTargets" "1"
data "AmountOfTargets" "1"

new entry "Shout_AlterTime_Teleport"
type "SpellData"
using "Target_AlterTime_Teleport"
data "SpellType" "Shout"
data "AreaRadius" "1000"


new entry "TimeLord"
type "PassiveData"
data "DisplayName" "hd33ee35eg14e5g4570gb7f2g2cd42170419a"
data "Description" "h930fe2a6gaa53g41ecgb9aegbe2bd8c308b1"
data "Properties" "Highlighted"
data "Icon" "PassiveFeature_Wizard_TimeLord"
data "StatsFunctorContext" "OnStatusApplied"
data "Conditions" "StatusId('ALTERING_TIME')"
data "StatsFunctors" "ApplyStatus(SELF,TIME_LORD,100,-1)"


new entry "TIME_LORD"
type "StatusData"
data "StatusType" "BOOST"
data "DisplayName" "hd33ee35eg14e5g4570gb7f2g2cd42170419a"
data "Description" ""
data "StatusPropertyFlags" "DisableOverhead;DisableCombatlog;DisablePortraitIndicator;ApplyToDead"
data "Icon" "PassiveFeature_Wizard_TimeLord"
data "Passives" "TimeLordVictorious"
data "RemoveEvents" "OnStatusRemoved"
data "RemoveConditions" "StatusId('ALTERING_TIME')"
data "StatusGroups" "SG_RemoveOnRespec"
data "OnApplyFunctors" "{{range $lvl := untilStep 1 7 1}}{{range $amt := untilStep 1 4 1}}IF(HasActionResource('SpellSlot',{{$amt}},{{$lvl}},false,false,context.Source)):ApplyStatus(TL_{{$lvl}}_{{$amt}},100,-1);{{end}}{{end}}"


{{ range $lvl := untilStep 1 7 1 }}
{{ range $amt := untilStep 1 5 1 }}
new entry "TL_{{$lvl}}_{{$amt}}"
type "StatusData"
data "StatusType" "BOOST"
data "DisplayName" ""
data "Description" ""
data "StackId" "TL_{{$lvl}}"
data "StackPriority" "{{$amt}}"
// data "StatusPropertyFlags" "DisableOverhead;DisableCombatlog;DisablePortraitIndicator;ApplyToDead"
data "RemoveEvents" "OnStatusRemoved"
data "RemoveConditions" "StatusId('ALTERING_TIME')"
data "OnRemoveFunctors" "{{range $i := untilStep 0 $amt 1 }}IF(HasPassive('TimeLordVictorious',context.Source) and not HasActionResource('SpellSlot',{{$lvl}},{{$amt}},false,false,context.Source)):RestoreResource(SELF,SpellSlot,1,{{$lvl}});{{end}}"
{{ end }}
{{ end }}

new entry "TimeLordVictorious"
type "PassiveData"
using "TimeLord"
data "Description" "h6570a5f2g4283g42cegb6ddg6ab7ad718aae"
data "Properties" "IsToggled;Temporary;OncePerLongRest"
data "StatsFunctorContext" "OnStatusRemoved"
data "Conditions" "StatusId('ALTERING_TIME')"
data "StatsFunctors" "RemoveStatus(SELF,TIME_LORD)"